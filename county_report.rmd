



```{r setup, echo=FALSE,results='hide', message=FALSE, warning=FALSE}

options(stringsAsFactors = FALSE)

# For the report
library(knitr)
library(mpmisc)
library(tbdbaid)

# For graphics
library(ggplot2)
library(gridExtra)

# For aggregation
library(plyr)
library(reshape2)


# Set default chunk options
opts_chunk$set(echo = FALSE,
               comment = "",
               message = FALSE,
               warning = TRUE,
               error = TRUE,
               fig.path = file.path("figure", x$prefix[1]),
               fig.width=8,
               fig.height=5.6,
               dpi=300,
               out.width="700px",
               dev="png",
               cache = FALSE)



# Set some plot parameters that will want tweaking
point_size <- 3
line_size <- 1.3
colorwheel <- c("#31A354", "#ADDD8E", "#F03B20", "#43A2CA")



# Get dates for the latest quarter, and for its corresponding quarter two
# years back
first.qtr <- get_quarter(Date = Sys.Date(), offset = -9)
last.qtr <- get_quarter(Date = Sys.Date(), offset = -1)



# Set up a theme for all the plots
theme_tb <- theme_bw() +
            theme(legend.key.width = unit(.75, "inches"))




```




# Tuberculosis Control Activities for `r paste(x$hd_label[1])`
## `r last.qtr$qtr`
### Provided by the Denver Metro TB Control Program


## TB Cases in `r paste(x$county_label[1])`
-------------------------------------------

```{r case_plot}

# Get active cases over the last ten years.
# Ensure that the oldest year is a full year

actives <- query_actives(
    start_date = as.Date(paste(as.numeric(format(Sys.Date(), "%Y")) - 10,
                               "-01-01", 
                               sep = "")),
    stop_date = last.qtr$end.date)

countyactives <- subset(actives, report_county %in% x$county)



# Ensure the plot always extends back ten years, even if no cases then
this_year <- as.numeric(format(last.qtr$end.date, "%Y"))
ten_ago <- this_year - 10

# Make it a factor - this seems like the easiest way
countyactives$yr_plot <- factor(countyactives$yr_id,
                                levels = seq(ten_ago, this_year, 1),
                                ordered = TRUE)


# Plot it
ggplot(countyactives, aes(x = yr_plot)) +
    geom_bar(color = "black", fill = "#1F78B4") +
    stat_bin(geom="text", 
             aes(label=..count.., vjust = 1.25),
             color = "white") +
    expand_limits(y = c(0, 3)) +
    scale_x_discrete(drop = FALSE) +
    labs(x = "Year Identified", 
         y = "Number of cases",
         title = "Number of Active TB Cases by Year Identified") +
    theme_tb


```



```{r case_table,results='asis'}

actives_print <- ddply(countyactives, 
                       .var = "yr_plot", 
                       .drop = FALSE,
                       .fun = summarise,
                       total = length(report_county)
)


# Print it with nice names
names(actives_print) <- c("Year", "Total Cases")

dfprintif(actives_print)


```

## Patient Visits by Location
-------------------------------------------

```{r visits_inout}


# Query visits in the period and add the county of residence
visits <- add_county(query_visits(start_date = first.qtr$start.date,
                                  stop_date = last.qtr$end.date))

# Subset to just visits from residents of the current county
visits_co <- subset(visits, county %in% x$county)


# Add a plot quarter label
visits_co$plot_qtr <- with(visits_co, 
                           paste(visit_yr, " Q", visit_qtr, sep = ""))


# Aggregate by quarter and location
locagg <- count(subset(visits_co, location %in% c("Clinic", "Outreach")),
                vars = c("plot_qtr", "location"))


# Aggregate by just quarter to get a total visits count
qtragg <- count(subset(visits_co, location %in% c("Clinic", "Outreach")),
                vars = "plot_qtr")

# Label it
qtragg$location <- "All Visits"


# Combine them
visitagg <- rbind(locagg, qtragg)


# Plot it
ggplot(visitagg, aes(x = plot_qtr, 
                     y = freq, 
                     group = location, 
                     color = location)) +
    geom_point(size = point_size) +
    geom_line(aes(linetype = location), size = line_size) +
    expand_limits(y = 0) +
    scale_color_manual("Visit Location", values = colorwheel[1:3]) +
    scale_linetype_discrete("Visit Location") +
    labs(x = "Visit date", 
         y = "Number of visits") +
    theme_tb + theme(axis.text.x = element_text(angle = 70, 
                                                hjust = 1.30, 
                                                vjust = 1.3))


```


```{r visits_table, results='asis'}

# Cast visits wide
visits_wide <- dcast(visitagg, plot_qtr ~ location, value.var = "freq")

# Pretty-print
names(visits_wide) <- c("Quarter", "Total Visits", "Clinic Visits", "Outreach Visits")

dfprintif(visits_wide)

```





```{r cleanup}



```

Updated at `r paste(Sys.time())`
